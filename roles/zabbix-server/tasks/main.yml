---
# tasks file for zabbix-server
- name: wget
  shell: wget -O /tmp/zabbix.deb https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.0+ubuntu24.04_all.deb

- name: dpkg
  shell: dpkg -i /tmp/zabbix.deb

- name: apt update
  apt:
    update_cache: yes

- name: install packages
  apt:
    name:
      - python3-pip
      - python3-pymysql
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-nginx-conf
      - zabbix-sql-scripts
      - zabbix-agent
      - mysql-server
    state: present
  notify: restart-mysql

- name: create mysql dir
  file:
    path: /etc/mysql/
    state: directory
    mode: '0750'

- name: import my.cnf template
  template:
    src: my.cnf.j2
    dest: /etc/mysql/my.cnf
    owner: root
    group: root
    mode: 0644
  notify: restart-mysql

# SETTING MYSQL 
- name: specify root password
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock

- name: setting utf8bm4 encoding
  mysql_db:
    name: zabbix
    encoding: utf8mb4
    collation: utf8mb4_bin
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: creating zabbix user w full access to db
  mysql_user:
    name: zabbix
    host: localhost
    password: "{{ zabbix_db_password }}"
    priv: "zabbix.*:ALL"
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: turning on var log_bin_trust_function_creators
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 1
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: import zabbix schema and data
  shell: zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p{{ zabbix_db_password }} zabbix

- name: turning off log_bin_trust_function_creators
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 0
    login_user: root
    login_password: "{{ mysql_root_password }}"

- name: import nginx.conf template
  template:
    src: nginx.conf
    dest: /etc/zabbix/nginx.conf

- name: zabbix conf file edit
  lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    line: "DBPassword={{ zabbix_db_password }}"
    create: yes
  notify:
   - restart-zabbix
